# Параллельный калькулятор с JWT-аутентификацией

## Описание проекта

Параллельный калькулятор - сервис, позволяющий выполнять арифметические вычисления с разбиением выражений на атомарные операции, которые выполняются параллельно. Система использует JWT-аутентификацию для защиты доступа к API и разграничения доступа пользователей к данным.

Принцип работы:

1. Пользователь регистрируется или входит в систему, получая JWT-токен
2. Используя полученный токен, пользователь отправляет арифметическое выражение через HTTP-запрос
3. Сервис возвращает уникальный идентификатор выражения
4. Выражение разбивается на простые операции и выполняется параллельно
5. Пользователь может получить результат по идентификатору выражения
6. Пользователь видит только свои выражения, защищенные JWT-аутентификацией

## Архитектура

Проект состоит из двух основных компонентов:

1. **Оркестратор** - сервер, который:

   - Принимает и разбирает арифметические выражения
   - Преобразует их в набор последовательных задач
   - Хранит результаты вычислений
2. **Агент** - вычислитель, который:

   - Получает задачи от оркестратора
   - Выполняет отдельные математические операции
   - Возвращает результаты оркестратору

Диаграмма архитектуры проекта
Sequence Diagram: Процесс обработки выражения

```mermaid
sequenceDiagram
    participant Client as Клиент
    participant Orch as Оркестратор
    participant Agent as Агент

    Client->>Orch: POST /api/v1/calculate\n(выражение)
    Orch-->>Client: 201, id выражения

    Client->>Orch: GET /api/v1/expressions
    Orch-->>Client: Список выражений

    loop Агент запрашивает задачи
        Agent->>Orch: GET /internal/task
        Orch-->>Agent: Задача для вычисления
        Agent->>Orch: POST /internal/task\n(результат)
    end
```

Описание:
Эта диаграмма показывает последовательность действий: Клиент отправляет запрос на вычисление, получает идентификатор, затем получает список выражений. Параллельно Агент в цикле запрашивает задачи у Оркестратора, выполняет вычисления и возвращает результат.

## Запуск проекта

### Установка зависимостей

```bash
go mod tidy
```

### Настройка конфигурации

Перед запуском необходимо создать файл `.env` в корневой папке проекта. Вы можете использовать файл `.env.example` как шаблон:

```bash
# Скопируйте пример конфигурации
cp .env.example .env

# Отредактируйте файл под свои нужды
nano .env
```

Основные параметры, которые нужно настроить:

```
# Порт для HTTP сервера
SERVER_PORT=8080

# Секретный ключ для JWT токенов
JWT_SECRET=your_very_secret_key

# Время жизни JWT токена в часах
JWT_EXPIRES_HOURS=24

# Время выполнения операций в миллисекундах
TIME_ADDITION_MS=100
TIME_SUBTRACTION_MS=100
TIME_MULTIPLICATION_MS=200
TIME_DIVISION_MS=300
```

### Запуск серверов

1. Сначала запускаем оркестратор:

```bash
go run cmd/orchestrator_server/main.go
```

2. Затем запускаем агента в отдельном терминале:

```bash
go run cmd/agent_server/main.go
```

После запуска обоих серверов система готова к работе.

## API проекта

Проект предоставляет несколько API эндпоинтов для работы с системой.

### Аутентификация

#### 1. Регистрация пользователя

```
POST /api/v1/register
```

**Тело запроса**:

```json
{
  "login": "username",
  "password": "password123"
}
```

**Коды ответа**:
- 200: Успешная регистрация
- 400: Ошибка валидации
- 409: Пользователь с таким логином уже существует
- 500: Ошибка сервера

#### 2. Вход в систему

```
POST /api/v1/login
```

**Тело запроса**:

```json
{
  "login": "username",
  "password": "password123"
}
```

**Коды ответа**:
- 200: Успешный вход
- 401: Ошибка аутентификации
- 500: Ошибка сервера

**Тело ответа при успешном входе**:

```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### Защищенные эндпоинты калькулятора

Для всех защищенных эндпоинтов необходимо добавить заголовок `Authorization` с JWT-токеном:

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### 1. Добавление вычисления арифметического выражения

```
POST /api/v1/calculate
```

**Тело запроса**:

```json
{
  "expression": "2+2*2"
}
```

**Коды ответа**:
- 201: Выражение принято для вычисления
- 401: Отсутствует или недействителен токен
- 422: Невалидные данные
- 500: Ошибка сервера

**Тело ответа**:

```json
{
  "id": 123
}
```

#### 2. Получение списка выражений

```
GET /api/v1/expressions
```

**Коды ответа**:
- 200: Успешно получен список выражений
- 401: Отсутствует или недействителен токен
- 500: Ошибка сервера

**Тело ответа**:

```json
{
  "expressions": [
    {
      "id": 123,
      "status": "completed",
      "result": 8
    },
    {
      "id": 124,
      "status": "in_progress",
      "result": null
    }
  ]
}
```

#### 3. Получение выражения по идентификатору

```
GET /api/v1/expressions/:id
```

**Коды ответа**:
- 200: Успешно получено выражение
- 401: Отсутствует или недействителен токен
- 404: Выражение не найдено или принадлежит другому пользователю
- 500: Ошибка сервера

**Тело ответа**:

```json
{
  "expression": {
    "id": 123,
    "status": "completed",
    "result": 8
  }
}
```

## Конфигурация

Полный список параметров конфигурации в файле `.env`:

| Параметр             | Описание                                        |
| ------------------------ | ----------------------------------------------- |
| SERVER_PORT             | Порт HTTP-сервера                       |
| JWT_SECRET              | Секретный ключ для подписи JWT-токенов |
| JWT_EXPIRES_HOURS       | Время жизни JWT-токена в часах       |
| TIME_ADDITION_MS        | Время выполнения операции сложения       |
| TIME_SUBTRACTION_MS     | Время выполнения операции вычитания     |
| TIME_MULTIPLICATION_MS  | Время выполнения операции умножения     |
| TIME_DIVISION_MS        | Время выполнения операции деления         |
| COMPUTING_POWER          | Количество параллельных вычислений          |
| AGENT_LOG_FILE_PATH      | Путь к файлу логирования агента                  |
| CLIENT_LOG_FILE_PATH     | Путь к файлу логирования клиента                |
| AGENT_REQUEST_TIMEOUT_MS | Как часто агент пытается получить задачу |
| SERVER_PORT              | Порт сервера                                                     |

## API Endpoints

Оркестратор предоставляет следующие API-эндпоинты:

### 1. Добавление вычисления арифметического выражения

```
POST /api/v1/calculate
```

**Тело запроса**:

```json
{
  "expression": "2+2*3"
}
```

**Коды ответа**:

- 201: Выражение принято для вычисления
- 422: Невалидные данные
- 500: Ошибка сервера

**Тело ответа**:

```json
{
  "id": 123
}
```

### 2. Получение списка выражений

```
GET /api/v1/expressions
```

**Коды ответа**:

- 200: Успешно получен список выражений
- 500: Ошибка сервера

**Тело ответа**:

```json
{
  "expressions": [
    {
      "id": 123,
      "status": "completed",
      "result": 8
    },
    {
      "id": 124,
      "status": "in_progress",
      "result": null
    }
  ]
}
```

### 3. Получение выражения по идентификатору

```
GET /api/v1/expressions/:id
```

**Коды ответа**:

- 200: Успешно получено выражение
- 404: Выражение не найдено
- 500: Ошибка сервера

**Тело ответа**:

```json
{
  "expression": {
    "id": 123,
    "status": "completed",
    "result": 8
  }
}
```

### 4. Внутренние API для агентов

#### Получение задачи для выполнения

```
GET /internal/task
```

**Коды ответа**:

- 200: Успешно получена задача
- 404: Задача не найдена
- 500: Ошибка сервера

**Тело ответа**:

```json
{
  "task": {
    "id": 1,
    "arg1": "2",
    "arg2": "3",
    "operation": "*",
    "operation_time": 100
  }
}
```

#### Прием результата обработки данных

```
POST /internal/task
```

**Тело запроса**:

```json
{
  "id": 1,
  "result": 6
}
```

**Коды ответа**:

- 200: Результат успешно записан
- 404: Задача не найдена
- 422: Невалидные данные
- 500: Ошибка сервера

## Агент

Агент — это демон, который получает задачи от оркестратора, выполняет их и возвращает результаты. Он запускает несколько горутин, каждая из которых действует как независимый вычислитель. Количество горутин определяется переменной окружения `COMPUTING_POWER`. Агент взаимодействует с оркестратором через HTTP.

### Процесс работы агента

1. Агент отправляет запрос на получение задачи: `GET /internal/task`.
2. Оркестратор возвращает задачу, если она доступна.
3. Агент выполняет вычисление и отправляет результат обратно оркестратору: `POST /internal/task`.

## Тестирование проекта

## Покрытие UNIT-тестами

UNIT-тесты были написаны для всех пакетов, покрывая их основную логику. Покрытие тестами составляет более 70%. Остальная часть непокрытого кода включает проверки для предотвращения случайных ошибок, которые сложно или почти невозможно воспроизвести.

## Тестирование проекта

### Unit-тесты

Проект покрыт автоматическими тестами, которые проверяют работоспособность основных компонентов системы. Для запуска тестов используйте команду:

```bash
go test ./... -v
```

Тесты проверяют следующие компоненты:

- **Оркестратор**: парсинг выражений, создание задач, управление состоянием выражений
- **Агент**: получение и выполнение задач, возврат результатов
- **База данных**: сохранение и загрузка выражений, задач, пользователей
- **JWT аутентификация**: создание и валидация токенов, разграничение доступа
- **gRPC коммуникация**: взаимодействие между агентом и оркестратором

### Тестирование с Postman

Для удобного тестирования API проект включает коллекцию Postman, которая содержит все необходимые запросы и автоматизированные сценарии.

#### Импорт и настройка коллекции:

1. Установите [Postman](https://www.postman.com/downloads/).
2. Откройте Postman и нажмите "Import" в верхнем левом углу.
3. Выберите файл коллекции `Параллельный калькулятор с JWT.postman_collection.json`
4. **Обязательно создайте окружение** в Postman:
   - Нажмите на иконку шестеренки (Environments) в левом столбце
   - Нажмите на "+" для создания нового окружения
   - Назовите его например "Calculator"
   - Выберите созданное окружение в верхнем правом углу

> **Важно!** Коллекция использует скрипты для автоматического сохранения JWT-токенов и ID выражений в переменные окружения, и для автоматической вставки токенов в заголовки запросов. Без настройки окружения скрипты не будут работать!

### Использование curl

Ниже приведены примеры использования curl для тестирования API. Все примеры предполагают, что сервер запущен на localhost:8080.

#### 1. Регистрация пользователя

```bash
curl --location 'localhost:8080/api/v1/register' \
--header 'Content-Type: application/json' \
--data '{
    "login": "testuser",
    "password": "password123"
}'
```

**Ожидаемый ответ:** 200 OK

#### 2. Вход в систему и получение JWT-токена

```bash
curl --location 'localhost:8080/api/v1/login' \
--header 'Content-Type: application/json' \
--data '{
    "login": "testuser",
    "password": "password123"
}' \
--output-format json | jq -r '.token' > token.txt
```

**Ожидаемый ответ:** 200 с JWT-токеном в json-ответе

> Здесь мы сохраняем токен в файл для использования в последующих запросах

#### 3. Создание выражения (с JWT-токеном)

```bash
export TOKEN=$(cat token.txt)
curl --location 'localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--header "Authorization: Bearer $TOKEN" \
--data '{
    "expression": "2+2*2"
}' \
--output-format json | jq -r '.id' > expression_id.txt
```

**Ожидаемый ответ:** 201 с ID созданного выражения

> Здесь мы сохраняем ID выражения для дальнейшего использования

#### 4. Получение списка выражений пользователя

```bash
curl --location 'localhost:8080/api/v1/expressions' \
--header "Authorization: Bearer $TOKEN"
```

**Ожидаемый ответ:** 200 со списком выражений

#### 5. Получение конкретного выражения по ID

```bash
export EXPR_ID=$(cat expression_id.txt)
curl --location "localhost:8080/api/v1/expressions/$EXPR_ID" \
--header "Authorization: Bearer $TOKEN"
```

**Ожидаемый ответ:** 200 с деталями выражения

#### 6. Попытка доступа без токена

```bash
curl --location 'localhost:8080/api/v1/expressions'
```

**Ожидаемый ответ:** 401 Unauthorized

#### 7. Отправка некорректного выражения

```bash
curl --location 'localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--header "Authorization: Bearer $TOKEN" \
--data '{
    "expression": "2++2"
}'
```

**Ожидаемый ответ:** 422 Unprocessable Entity

#### 8. Отправка выражения с делением на ноль

```bash
curl --location 'localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--header "Authorization: Bearer $TOKEN" \
--data '{
    "expression": "2/0"
}'
```

**Ожидаемый ответ:** 201, но в результате вычисления будет ошибка "division by zero".

#### 9. Отправка сложного выражения со скобками

```bash
curl --location 'localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--header "Authorization: Bearer $TOKEN" \
--data '{
    "expression": "(15+5)*2/4-3.5"
}'
```

**Ожидаемый ответ:** 201 с ID созданного выражения

> **Примечание:** Для удобства можно создать баш-скрипт, который выполнит полный цикл регистрации, входа и создания выражения.