# Параллельный калькулятор

## Описание проекта

Параллельный калькулятор - сервис, позволяющий выполнять арифметические вычисления с разбиением выражений на атомарные операции, которые выполняются параллельно.

Принцип работы:

1. Пользователь отправляет арифметическое выражение через HTTP-запрос
2. Сервис возвращает уникальный идентификатор выражения
3. Выражение разбивается на простые операции и выполняется параллельно
4. Пользователь может получить результат по идентификатору выражения

## Архитектура

Проект состоит из двух основных компонентов:

1. **Оркестратор** - сервер, который:

   - Принимает и разбирает арифметические выражения
   - Преобразует их в набор последовательных задач
   - Обеспечивает порядок выполнения операций
   - Хранит результаты вычислений
2. **Агент** - вычислитель, который:

   - Получает задачи от оркестратора
   - Выполняет отдельные математические операции
   - Возвращает результаты оркестратору

Диаграмма архитектуры проекта
1. Flowchart: Взаимодействие компонентов

flowchart TD
    A[Клиент] -->|POST /api/v1/calculate<br/>(выражение)| B[Оркестратор]
    B -->|201: id выражения| A
    A -->|GET /api/v1/expressions| B
    B -->|Список выражений| A

    subgraph Внутреннее взаимодействие
        C[Агент] -->|GET /internal/task<br/>(запрос задачи)| B
        B -->|Задача для вычисления| C
        C -->|POST /internal/task<br/>(результат)| B
    end

Описание:
Клиент отправляет запросы на добавление и получение выражений через публичные endpoint-ы оркестратора. Одновременно Агент постоянно обращается к оркестратору для получения задач (GET /internal/task) и отправляет результаты вычислений (POST /internal/task).

## Запуск проекта

### Установка зависимостей

```bash
go mod tidy
```

### Запуск серверов

1. Сначала запускаем оркестратор:

```bash
go run cmd/orchestrator_server/main.go
```

2. Затем запускаем агента:

```bash
go run cmd/agent_server/main.go
```

## Конфигурация

Настройки проекта находятся в файле `configs/.env`:


| Параметр         | Описание                                                            |
| -------------------------- | ----------------------------------------------------------------------------- |
| TIME_ADDITION_MS         | Время выполнения операции сложения           |
| TIME_SUBTRACTION_MS      | Время выполнения операции вычитания         |
| TIME_MULTIPLICATION_MS   | Время выполнения операции умножения         |
| TIME_DIVISION_MS         | Время выполнения операции деления             |
| COMPUTING_POWER          | Количество параллельных вычислений          |
| AGENT_LOG_FILE_PATH      | Путь к файлу логирования агента                  |
| CLIENT_LOG_FILE_PATH     | Путь к файлу логирования клиента                |
| AGENT_REQUEST_TIMEOUT_MS | Как часто агент пытается получить задачу |
| SERVER_PORT              | Порт сервера                                                     |

## API Endpoints

Оркестратор предоставляет следующие API-эндпоинты:

### 1. Добавление вычисления арифметического выражения

```
POST /api/v1/calculate
```

**Тело запроса**:

```json
{
  "expression": "2+2*3"
}
```

**Коды ответа**:

- 201: Выражение принято для вычисления
- 422: Невалидные данные
- 500: Ошибка сервера

**Тело ответа**:

```json
{
  "id": 123
}
```

### 2. Получение списка выражений

```
GET /api/v1/expressions
```

**Коды ответа**:

- 200: Успешно получен список выражений
- 500: Ошибка сервера

**Тело ответа**:

```json
{
  "expressions": [
    {
      "id": 123,
      "status": "completed",
      "result": 8
    },
    {
      "id": 124,
      "status": "in_progress",
      "result": null
    }
  ]
}
```

### 3. Получение выражения по идентификатору

```
GET /api/v1/expressions/:id
```

**Коды ответа**:

- 200: Успешно получено выражение
- 404: Выражение не найдено
- 500: Ошибка сервера

**Тело ответа**:

```json
{
  "expression": {
    "id": 123,
    "status": "completed",
    "result": 8
  }
}
```

### 4. Внутренние API для агентов

#### Получение задачи для выполнения

```
GET /internal/task
```

**Коды ответа**:

- 200: Успешно получена задача
- 404: Задача не найдена
- 500: Ошибка сервера

**Тело ответа**:

```json
{
  "task": {
    "id": 1,
    "arg1": "2",
    "arg2": "3",
    "operation": "*",
    "operation_time": 100
  }
}
```

#### Прием результата обработки данных

```
POST /internal/task
```

**Тело запроса**:

```json
{
  "id": 1,
  "result": 6
}
```

**Коды ответа**:

- 200: Результат успешно записан
- 404: Задача не найдена
- 422: Невалидные данные
- 500: Ошибка сервера

## Агент

Агент — это демон, который получает задачи от оркестратора, выполняет их и возвращает результаты. Он запускает несколько горутин, каждая из которых действует как независимый вычислитель. Количество горутин определяется переменной окружения `COMPUTING_POWER`. Агент взаимодействует с оркестратором через HTTP.

### Процесс работы агента

1. Агент отправляет запрос на получение задачи: `GET /internal/task`.
2. Оркестратор возвращает задачу, если она доступна.
3. Агент выполняет вычисление и отправляет результат обратно оркестратору: `POST /internal/task`.

## Тестирование проекта

## Покрытие UNIT-тестами

UNIT-тесты были написаны только для пакета **orchestrator**, так как он является самым сложным и основным пакетом, содержащим всю основную логику проекта. Покрытие тестами составляет 88%. Остальная часть непокрытого кода включает проверки для предотвращения случайных ошибок, которые сложно или почти невозможно воспроизвести.

### Использование Postman

Основные тестовые сценарии собраны в коллекции Postman.

#### Импорт коллекции Postman:

1. Установите [Postman](https://www.postman.com/downloads/).
2. Откройте Postman и нажмите "Import" в верхнем левом углу.
3. Выберите файл коллекции, который находиться в папке 'configs'.
4. Создайте окружение переменных:
   - Откройте любой запрос из коллекции
   - В правом верхнем углу будет меню "Environment
   - Ссоздайте новое окружение
   - Выберите созданное окружение из выпадающего списка.

#### Сценарии тестирования:

**Отправка выражения**:

1. **simple expression** - отправка простого выражения, ID сохраняется автоматически.
2. **incorrect data** - отправка некорректного выражения (код 422).
3. **division by zero** - отправка выражения с делением на ноль.

**Получение результата**:

1. **get one expression** - получение выражения по ID.
2. **expression not found** - проверка обработки несуществующего ID (код 404).
3. **get last expression** - получение результата последнего отправленного выражения.
4. **get all expressions** - получение списка всех выражений.

### Использование curl

#### Тестирование с использованием curl

Здесь приведены примеры curl-запросов для тестирования различных сценариев:

#### Стандартный запрос

Отправка корректного арифметического выражения:
```bash
curl --location 'localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
    "expression": "2+2*2"
}'
```
**Ожидаемый ответ:** 201

#### Некорректный запрос

Отправка некорректного выражения:
```bash
curl --location 'localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
    "expression": "incorrect expression"
}'
```
**Ожидаемый ответ:** 422

#### Деление на ноль

Отправка выражения с делением на ноль:
```bash
curl --location 'localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
    "expression": "2/0"
}'
```
**Ожидаемый ответ:** 201, но в результате вычисления будет ошибка "division by zero".

#### Получение несуществующего выражения

Запрос на получение выражения по несуществующему ID:
```bash
curl --location 'localhost:8080/api/v1/expressions/0'
```
**Ожидаемый ответ:** 404

#### Получение списка выражений

Запрос на получение списка всех выражений:
```bash
curl --location 'localhost:8080/api/v1/expressions'
```
**Ожидаемый ответ:** 200

> **Примечание:** Запросы с ответом 500 возможны, но их трудно воспроизвести.